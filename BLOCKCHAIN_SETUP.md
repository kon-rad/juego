# Blockchain Setup Guide

This guide will help you configure the blockchain connection for both local development and production environments.

## Environment Modes

The backend supports two blockchain modes, controlled by the `BLOCKCHAIN_ENV` environment variable:

- **`local`** (default): Uses local Hardhat node with contracts deployed locally
- **`production`**: Uses production blockchain (Ronin) with deployed contract addresses

## Local Development Setup

### 1. Start Local Blockchain

In one terminal, start the Hardhat local blockchain:

```bash
cd apps/contracts
npx hardhat node
```

Keep this terminal running. You should see:
- Started HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/
- A list of 20 accounts with their private keys

### 2. Deploy Contracts to Local Network

In a new terminal:

```bash
cd apps/contracts
npm run deploy:localhost
```

This script will:
- âœ… Deploy `LearnToken` contract
- âœ… Deploy `BadgeNFT` contract
- âœ… Update `deployed-addresses.json` with new addresses
- âœ… Automatically update `apps/backend/src/lib/contracts.json` with ABIs and addresses

You should see output like:
```
ðŸš€ Starting local deployment...
âœ… LearnToken deployed to: 0x5FbDB2315678afecb367f032d93F642f64180aa3
âœ… BadgeNFT deployed to: 0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
âœ… Backend contracts config updated
```

### 3. Configure Backend for Local Mode

Make sure your backend `.env` has:

```bash
# Backend .env - Local Development
BLOCKCHAIN_ENV=local

# Local blockchain configuration
LOCAL_RPC_URL=http://127.0.0.1:8545
LOCAL_ADMIN_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80
```

> **Note**: The private key above is Hardhat's default first account (Account #0). This is safe for local development only!

## Production Setup

### Configure Backend for Production Mode

Update your backend `.env`:

```bash
# Backend .env - Production
BLOCKCHAIN_ENV=production

# Production blockchain configuration
PRODUCTION_RPC_URL=https://api.roninchain.com/rpc
PRODUCTION_ADMIN_PRIVATE_KEY=your_secure_private_key_here
PRODUCTION_LEARN_TOKEN_ADDRESS=0xD7f0998e629b841747ba5cF4646DCc064d24Ad74
PRODUCTION_BADGE_NFT_ADDRESS=0x89A9dC0A72ebB5Fa99A9872140dF40E46DF09e66
```

In production mode:
- Contract addresses come from environment variables
- ABIs are loaded from `contracts.json` or contract artifacts
- Uses the production RPC endpoint
- Uses your secure production private key

### 4. Restart Backend

Restart your backend server to load the new contract addresses:

```bash
cd apps/backend
npm run dev
```

You should now see in the logs:
```
Initializing blockchain service...
  RPC URL: http://127.0.0.1:8545
Testing blockchain connection...
  Connected to network: chainId=31337
Testing contract connections...
  Token contract: Learn Token at 0x5FbDB...
  NFT contract: Quest Badge at 0xe7f17...
âœ… Blockchain service initialized successfully
```

## Verification

Test that everything works:

```bash
curl http://localhost:3001/api/blockchain/stats
```

You should get a response with contract information:
```json
{
  "nfts": {
    "totalMinted": "0",
    "name": "Quest Badge",
    "symbol": "BADGE",
    "contractAddress": "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
  },
  "tokens": {
    "totalSupply": "0.0",
    "name": "Learn Token",
    "symbol": "LEARN",
    "contractAddress": "0x5FbDB2315678afecb367f032d93F642f64180aa3"
  }
}
```

## Troubleshooting

### Error: "could not decode result data"

**Cause**: Contracts not deployed or wrong addresses in config

**Solution**: Run the deploy script again:
```bash
cd apps/contracts
npm run deploy:localhost
```

### Error: "Master key not found"

**Cause**: Database missing encryption key for wallet storage

**Solution**: This is now automatically created on first wallet request. Just try again.

### Error: "ECONNREFUSED 127.0.0.1:8545"

**Cause**: Local blockchain not running

**Solution**: Start Hardhat node:
```bash
cd apps/contracts
npx hardhat node
```

### Contracts deployed to wrong network

If `deployed-addresses.json` shows "ronin" or "saigon" but you want localhost:

1. Stop backend
2. Run `npm run deploy:localhost` in contracts directory
3. Restart backend

## Environment Variable Reference

### Local Mode (`BLOCKCHAIN_ENV=local`)
| Variable | Description | Default |
|----------|-------------|---------|
| `BLOCKCHAIN_ENV` | Environment mode | `local` |
| `LOCAL_RPC_URL` | Local blockchain RPC | `http://127.0.0.1:8545` |
| `LOCAL_ADMIN_PRIVATE_KEY` | Admin wallet private key | Hardhat Account #0 |

**Contract addresses**: Loaded from `apps/backend/src/lib/contracts.json` (auto-generated by deploy script)

### Production Mode (`BLOCKCHAIN_ENV=production`)
| Variable | Description | Required |
|----------|-------------|----------|
| `BLOCKCHAIN_ENV` | Environment mode | Yes |
| `PRODUCTION_RPC_URL` | Production blockchain RPC | Yes |
| `PRODUCTION_ADMIN_PRIVATE_KEY` | Secure admin private key | Yes |
| `PRODUCTION_LEARN_TOKEN_ADDRESS` | LearnToken contract address | Yes |
| `PRODUCTION_BADGE_NFT_ADDRESS` | BadgeNFT contract address | Yes |

**Contract addresses**: Loaded from environment variables

### Legacy/Fallback Variables
| Variable | Description | Note |
|----------|-------------|------|
| `RPC_URL` | Fallback RPC URL | Used if mode-specific not set |
| `ADMIN_PRIVATE_KEY` | Fallback private key | Used if mode-specific not set |

## Network Configuration

### Local Development
- Network: Hardhat (localhost)
- Chain ID: 31337
- RPC: http://127.0.0.1:8545
- Accounts: Pre-funded test accounts
- Mode: `BLOCKCHAIN_ENV=local`

### Ronin Saigon Testnet
- Network: Saigon
- Chain ID: 2021
- RPC: https://saigon-testnet.roninchain.com/rpc
- Mode: `BLOCKCHAIN_ENV=production`
- Deploy: `npm run deploy:saigon`

### Ronin Mainnet
- Network: Ronin
- Chain ID: 2020
- RPC: https://api.roninchain.com/rpc
- Mode: `BLOCKCHAIN_ENV=production`
- Deploy: `npm run deploy:ronin`

## File Locations

- Contract source: `apps/contracts/contracts/`
- Deployment script: `apps/contracts/scripts/deploy-local-and-sync.js`
- Deployed addresses: `apps/contracts/deployed-addresses.json`
- Backend config: `apps/backend/src/lib/contracts.json`
- Backend service: `apps/backend/src/services/blockchain.service.ts`

## Tips

1. **Reset Everything**: If you restart `npx hardhat node`, you need to redeploy contracts
2. **Check Logs**: Backend logs show detailed blockchain initialization info
3. **Test Accounts**: Hardhat provides 20 test accounts, each with 10,000 ETH
4. **Contract Changes**: After modifying contracts, run `npm run compile` then redeploy
